name: Release on Tag

on:
  push:
    tags:
      - "v*.*.*"  # triggers only for tags like v1.2.3

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
    - name: Run cargo check
      run: cargo check --verbose
    - name: Run tests
      run: cargo test -p n42-testing

  release:
    name: Build and create release
    runs-on: ubuntu-latest
    needs: test   # only run if the test job passes
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
    - name: Build release binary
      run: cargo build --release
    - name: Upload binary via SCP
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "target/release/n42"
        target: "n42-releases/${{ github.ref_name }}/"
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        files: |
          target/release/n42
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
